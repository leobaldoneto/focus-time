<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Pomodoro Timer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Updated Font Awesome link -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    /* Styles for the circular progress bar */
    .progress-ring {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }

    .progress-ring svg {
      position: absolute;
      top: 0;
      left: 0;
    }

    .progress-ring circle {
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 1s linear;
    }

    /* Dark mode styles */
    body.dark-mode {
      background-color: #1a202c;
      color: #a0aec0;
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode select {
      background-color: #2d3748;
      color: #a0aec0;
      border-color: #4a5568;
    }

    body.dark-mode table {
      background-color: #2d3748;
      color: #a0aec0;
    }

    body.dark-mode th,
    body.dark-mode td {
      border-color: #4a5568;
    }

    body.dark-mode .bg-white {
      background-color: #2d3748 !important;
    }

    body.dark-mode .bg-gray-100 {
      background-color: #1a202c !important;
    }

    body.dark-mode .bg-gray-800 {
      background-color: #4a5568 !important;
    }

    body.dark-mode .bg-gray-500 {
      background-color: #4a5568 !important;
    }

    body.dark-mode .text-white {
      color: #a0aec0 !important;
    }

    body.dark-mode #notification {
      background-color: #4a5568;
      color: #a0aec0;
    }

    body.dark-mode button:hover {
      background-color: #4a5568;
    }

    body.dark-mode #progress-ring-circle {
      stroke: #a0aec0;
    }

    /* Notification styles */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #3182ce;
      color: white;
      padding: 10px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }

    /* Completed Pomodoros Indicator */
    #session-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .pomo-icon {
      color: gray;
      margin: 0 5px;
      font-size: 1.5rem;
    }

    .pomo-icon.completed {
      color: tomato;
    }

    /* Active mode button */
    .mode-button.active {
      border-bottom: 2px solid currentColor;
    }

    /* Settings modal content styling */
    #settings-modal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .progress-ring {
        width: 150px;
        height: 150px;
      }

      #timer-display {
        font-size: 3rem;
      }
    }
  </style>
</head>

<body class="bg-gray-100">
  <!-- Header -->
  <div class="bg-white p-4 flex justify-end items-center shadow">
    <!-- Right side: Settings, Dark Mode, and Language Selector -->
    <div class="flex space-x-4">
      <button id="settings-button" class="px-4 py-2 bg-gray-500 text-white rounded" aria-label="Settings">
        <i class="fas fa-cog"></i>
      </button>
      <button id="dark-mode-toggle" class="px-4 py-2 bg-gray-500 text-white rounded" aria-label="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
      </button>
      <!-- Language Selector -->
      <select id="language-selector" class="px-2 py-2 bg-gray-500 text-white rounded" aria-label="Language Selector">
        <option value="en">English</option>
        <option value="pt">Português</option>
      </select>
    </div>
  </div>

  <div class="text-center" id="app">
    <!-- Mode Buttons -->
    <div class="flex justify-center space-x-4 mb-4 mt-4">
      <button id="pomodoro-button" class="mode-button px-4 py-2 text-red-500 hover:text-red-700"
        aria-label="Pomodoro Mode">
        <i class="fas fa-clock mr-1"></i> Pomodoro
      </button>
      <button id="short-break-button" class="mode-button px-4 py-2 text-green-500 hover:text-green-700"
        aria-label="Short Break Mode">
        <i class="fas fa-coffee mr-1"></i> Short Break
      </button>
      <button id="long-break-button" class="mode-button px-4 py-2 text-blue-500 hover:text-blue-700"
        aria-label="Long Break Mode">
        <i class="fas fa-umbrella-beach mr-1"></i> Long Break
      </button>
    </div>

    <!-- Circular Timer Display -->
    <div class="progress-ring mb-4 mx-auto">
      <svg width="100%" height="100%">
        <circle id="progress-ring-circle-bg" stroke="#e6e6e6" stroke-width="10" fill="transparent" r="90" cx="100"
          cy="100"></circle>
        <circle id="progress-ring-circle" stroke="tomato" stroke-width="10" fill="transparent" r="90" cx="100" cy="100">
        </circle>
      </svg>
      <div id="timer-display" role="timer" aria-live="polite"
        class="text-6xl font-bold absolute top-0 left-0 w-full h-full flex items-center justify-center">
        25:00
      </div>
    </div>

    <!-- Start and Skip Buttons -->
    <div class="flex justify-center items-center space-x-4 mb-4">
      <button id="start-pause-button" class="px-4 py-2 bg-gray-800 text-white rounded" aria-label="Start Timer">
        <i class="fas fa-play mr-1"></i> Start
      </button>
      <button id="skip-button" class="px-4 py-2 bg-gray-800 text-white rounded" aria-label="Skip Timer">
        <i class="fas fa-forward"></i> Skip
      </button>
    </div>

    <!-- Visual Indicator for Completed Pomodoros -->
    <div id="session-indicator"></div>

    <!-- Notification -->
    <div id="notification"></div>

    <!-- Task Input and History Log -->
    <div class="mb-4 px-4">
      <!-- Task Input -->
      <label for="task-input" class="sr-only">Task Input</label>
      <input id="task-input" type="text" placeholder="What are you working on?"
        class="mb-4 px-4 py-2 border rounded w-full max-w-2xl" aria-label="Task Input">
      <!-- Use a table to show the history -->
      <div class="overflow-x-auto">
        <table id="history-log"
          class="text-left mx-auto w-full max-w-2xl h-40 overflow-y-scroll border rounded p-2 bg-white">
          <thead>
            <tr>
              <th class="px-2 py-1 border-b">Type</th>
              <th class="px-2 py-1 border-b">Task</th>
              <th class="px-2 py-1 border-b">Start</th>
              <th class="px-2 py-1 border-b">End</th>
              <th class="px-2 py-1 border-b">Duration</th>
            </tr>
          </thead>
          <tbody>
            <!-- Entries will be appended here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
    role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
    <div class="bg-white rounded-lg p-6 w-80 modal-content">
      <h2 id="settings-modal-title" class="text-xl font-bold mb-4">Settings</h2>
      <div class="mb-4">
        <label for="pomodoro-time-input" class="block text-left mb-2">Pomodoro Time (minutes):</label>
        <input id="pomodoro-time-input" type="number" min="1" class="w-full border rounded px-2 py-1" value="25">
      </div>
      <div class="mb-4">
        <label for="short-break-time-input" class="block text-left mb-2">Short Break Time (minutes):</label>
        <input id="short-break-time-input" type="number" min="1" class="w-full border rounded px-2 py-1" value="5">
      </div>
      <div class="mb-4">
        <label for="long-break-time-input" class="block text-left mb-2">Long Break Time (minutes):</label>
        <input id="long-break-time-input" type="number" min="1" class="w-full border rounded px-2 py-1" value="15">
      </div>
      <div class="mb-4 flex items-center">
        <input id="continuous-mode-checkbox" type="checkbox" class="mr-2">
        <label for="continuous-mode-checkbox">Enable Continuous Pomodoro Mode</label>
      </div>
      <div class="mb-4">
        <label for="break-multiplier-input" class="block text-left mb-2">Short Break Multiplier:</label>
        <input id="break-multiplier-input" type="number" step="0.1" min="0" class="w-full border rounded px-2 py-1"
          value="0.2">
      </div>
      <div class="mb-4">
        <label for="long-break-multiplier-input" class="block text-left mb-2">Long Break Multiplier:</label>
        <input id="long-break-multiplier-input" type="number" step="0.1" min="0" class="w-full border rounded px-2 py-1"
          value="0.2">
      </div>
      <div class="mb-4">
        <label for="sessions-before-long-break-input" class="block text-left mb-2">Sessions Before Long Break:</label>
        <input id="sessions-before-long-break-input" type="number" min="1" class="w-full border rounded px-2 py-1"
          value="4">
      </div>
      <!-- Webhook Settings -->
      <div class="mb-4 flex items-center">
        <input id="enable-webhook-checkbox" type="checkbox" class="mr-2">
        <label for="enable-webhook-checkbox">Enable Webhooks</label>
      </div>
      <div class="mb-4">
        <label for="webhook-url-input" class="block text-left mb-2">Webhook URL:</label>
        <input id="webhook-url-input" type="url" class="w-full border rounded px-2 py-1"
          placeholder="https://example.com/webhook">
      </div>
      <!-- Clear History Button -->
      <div class="mb-4">
        <button id="clear-history-button" class="px-4 py-2 bg-red-500 text-white rounded">Clear History</button>
      </div>
      <!-- Reset App State Button -->
      <div class="mb-4">
        <button id="reset-app-button" class="px-4 py-2 bg-red-500 text-white rounded">Reset App</button>
      </div>
      <div class="flex justify-end space-x-2">
        <button id="close-settings-button" class="px-4 py-2 bg-gray-500 text-white rounded">Close</button>
        <button id="save-settings-button" class="px-4 py-2 bg-blue-500 text-white rounded">Save</button>
      </div>
    </div>
  </div>
  <script>
    (function () {
      'use strict';

      // Request notification permission
      if ('Notification' in window) {
        Notification.requestPermission();
      }

      let timer;
      let isRunning = false;
      let timeRemaining = 25 * 60;
      let currentMode = 'pomodoro';
      let continuousMode = false;
      let breakMultiplier = 0.2;
      let longBreakMultiplier = 0.2;
      let focusTime = 0;
      let completedSessions = 0;
      let sessionsBeforeLongBreak = 4;
      let historyLog = [];
      let enableWebhook = false;
      let webhookURL = '';
      let expectedEndTime = null;
      let currentLanguage = 'en';

      const defaultTimes = {
        pomodoro: 25 * 60,
        shortBreak: 5 * 60,
        longBreak: 15 * 60
      };

      const elements = {
        timerDisplay: document.getElementById('timer-display'),
        startPauseButton: document.getElementById('start-pause-button'),
        skipButton: document.getElementById('skip-button'),
        pomodoroButton: document.getElementById('pomodoro-button'),
        shortBreakButton: document.getElementById('short-break-button'),
        longBreakButton: document.getElementById('long-break-button'),
        settingsButton: document.getElementById('settings-button'),
        settingsModal: document.getElementById('settings-modal'),
        closeSettingsButton: document.getElementById('close-settings-button'),
        saveSettingsButton: document.getElementById('save-settings-button'),
        taskInput: document.getElementById('task-input'),
        historyList: document.getElementById('history-log'),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        notification: document.getElementById('notification'),
        progressRingCircle: document.getElementById('progress-ring-circle'),
        progressRingCircleBg: document.getElementById('progress-ring-circle-bg'),
        sessionIndicator: document.getElementById('session-indicator'),
        pomodoroTimeInput: document.getElementById('pomodoro-time-input'),
        shortBreakTimeInput: document.getElementById('short-break-time-input'),
        longBreakTimeInput: document.getElementById('long-break-time-input'),
        continuousModeCheckbox: document.getElementById('continuous-mode-checkbox'),
        breakMultiplierInput: document.getElementById('break-multiplier-input'),
        longBreakMultiplierInput: document.getElementById('long-break-multiplier-input'),
        sessionsBeforeLongBreakInput: document.getElementById('sessions-before-long-break-input'),
        enableWebhookCheckbox: document.getElementById('enable-webhook-checkbox'),
        webhookURLInput: document.getElementById('webhook-url-input'),
        clearHistoryButton: document.getElementById('clear-history-button'),
        resetAppButton: document.getElementById('reset-app-button'),
        languageSelector: document.getElementById('language-selector')
      };

      const alarmSound = new Audio('alarm.mp3'); // Alarm sound when time is up

      const translations = {
        en: {
          settings: 'Settings',
          toggleDarkMode: 'Toggle Dark Mode',
          pomodoro: 'Pomodoro',
          shortBreak: 'Short Break',
          longBreak: 'Long Break',
          start: 'Start',
          pause: 'Pause',
          skip: 'Skip',
          whatAreYouWorkingOn: 'What are you working on?',
          taskInputLabel: 'Task Input',
          type: 'Type',
          task: 'Task',
          startTime: 'Start',
          endTime: 'End',
          duration: 'Duration',
          settingsModalTitle: 'Settings',
          pomodoroTime: 'Pomodoro Time (minutes):',
          shortBreakTime: 'Short Break Time (minutes):',
          longBreakTime: 'Long Break Time (minutes):',
          enableContinuousMode: 'Enable Continuous Pomodoro Mode',
          shortBreakMultiplier: 'Short Break Multiplier:',
          longBreakMultiplier: 'Long Break Multiplier:',
          sessionsBeforeLongBreak: 'Sessions Before Long Break:',
          enableWebhooks: 'Enable Webhooks',
          webhookURL: 'Webhook URL:',
          clearHistory: 'Clear History',
          resetApp: 'Reset App',
          close: 'Close',
          save: 'Save',
          timeForShortBreak: 'Time for a Short Break!',
          timeForLongBreak: 'Time for a Long Break!',
          backToWork: 'Back to Work!',
          shortBreakForMinutes: 'Short Break for {minutes} minutes',
          pomodoroCompleted: 'Pomodoro completed!',
          timerSkipped: 'Timer skipped!',
          webhookError: 'Webhook error:',
          confirmClearHistory: 'Are you sure you want to clear the history?',
          confirmResetApp: 'Are you sure you want to reset the app? This will erase all data.',
          noTask: 'No Task',
          stopped: 'stopped',
          paused: 'paused',
          focusing: 'focusing',
          short_break: 'short_break',
          long_break: 'long_break',
          pomodoroSkipped: 'Pomodoro (Skipped)',
        },
        pt: {
          settings: 'Configurações',
          toggleDarkMode: 'Alternar Modo Escuro',
          pomodoro: 'Pomodoro',
          shortBreak: 'Pausa Curta',
          longBreak: 'Pausa Longa',
          start: 'Iniciar',
          pause: 'Pausar',
          skip: 'Pular',
          whatAreYouWorkingOn: 'No que você está trabalhando?',
          taskInputLabel: 'Entrada de Tarefa',
          type: 'Tipo',
          task: 'Tarefa',
          startTime: 'Início',
          endTime: 'Fim',
          duration: 'Duração',
          settingsModalTitle: 'Configurações',
          pomodoroTime: 'Tempo de Pomodoro (minutos):',
          shortBreakTime: 'Tempo de Pausa Curta (minutos):',
          longBreakTime: 'Tempo de Pausa Longa (minutos):',
          enableContinuousMode: 'Ativar Modo Pomodoro Contínuo',
          shortBreakMultiplier: 'Multiplicador de Pausa Curta:',
          longBreakMultiplier: 'Multiplicador de Pausa Longa:',
          sessionsBeforeLongBreak: 'Sessões antes da Pausa Longa:',
          enableWebhooks: 'Ativar Webhooks',
          webhookURL: 'URL do Webhook:',
          clearHistory: 'Limpar Histórico',
          resetApp: 'Redefinir App',
          close: 'Fechar',
          save: 'Salvar',
          timeForShortBreak: 'Hora de uma Pausa Curta!',
          timeForLongBreak: 'Hora de uma Pausa Longa!',
          backToWork: 'Volte ao trabalho!',
          shortBreakForMinutes: 'Pausa Curta de {minutes} minutos',
          pomodoroCompleted: 'Pomodoro concluído!',
          timerSkipped: 'Cronômetro pulado!',
          webhookError: 'Erro de Webhook:',
          confirmClearHistory: 'Tem certeza de que deseja limpar o histórico?',
          confirmResetApp: 'Tem certeza de que deseja redefinir o app? Isso apagará todos os dados.',
          noTask: 'Sem Tarefa',
          stopped: 'parado',
          paused: 'pausado',
          focusing: 'focando',
          short_break: 'pausa_curta',
          long_break: 'pausa_longa',
          pomodoroSkipped: 'Pomodoro (Pulado)',
        }
      };

      function loadSettings() {
        const settings = localStorage.getItem('settings');
        if (settings) {
          const {
            defaultTimes: dt,
            continuousMode: cm,
            breakMultiplier: bm,
            longBreakMultiplier: lbm,
            sessionsBeforeLongBreak: sblb,
            enableWebhook: ew,
            webhookURL: wu,
            darkMode: dm,
            language: lang,
          } = JSON.parse(settings);
          Object.assign(defaultTimes, dt);
          continuousMode = cm;
          breakMultiplier = bm;
          longBreakMultiplier = lbm;
          sessionsBeforeLongBreak = sblb;
          enableWebhook = ew;
          webhookURL = wu;
          currentLanguage = lang || 'en';
          elements.languageSelector.value = currentLanguage;
          if (dm) {
            document.body.classList.add('dark-mode');
          }
        } else {
          currentLanguage = 'en';
          elements.languageSelector.value = 'en';
        }
      }

      function saveSettings() {
        const settings = {
          defaultTimes,
          continuousMode,
          breakMultiplier,
          longBreakMultiplier,
          sessionsBeforeLongBreak,
          enableWebhook,
          webhookURL,
          darkMode: document.body.classList.contains('dark-mode'),
          language: currentLanguage,
        };
        localStorage.setItem('settings', JSON.stringify(settings));
      }

      function loadStatus() {
        const status = localStorage.getItem('timerStatus');
        if (status) {
          const {
            timeRemaining: tr,
            currentMode: cm,
            isRunning: ir,
            focusTime: ft,
            completedSessions: cs,
            expectedEndTime: eet,
            taskInputValue: tiv
          } = JSON.parse(status);
          timeRemaining = tr;
          currentMode = cm;
          isRunning = ir;
          focusTime = ft;
          completedSessions = cs;
          expectedEndTime = eet;
          elements.taskInput.value = tiv || '';
          if (isRunning && expectedEndTime) {
            const now = Date.now();
            const newTimeRemaining = Math.floor((expectedEndTime - now) / 1000);
            if (newTimeRemaining > 0) {
              timeRemaining = newTimeRemaining;
            } else {
              timeRemaining = 0;
              isRunning = false;
              handleTimerCompletion();
            }
          }
        } else {
          timeRemaining = defaultTimes[currentMode];
        }
      }

      function saveStatus() {
        const status = {
          timeRemaining,
          currentMode,
          isRunning,
          focusTime,
          completedSessions,
          expectedEndTime,
          taskInputValue: elements.taskInput.value
        };
        localStorage.setItem('timerStatus', JSON.stringify(status));
      }

      function loadHistory() {
        const history = localStorage.getItem('historyLog');
        if (history) {
          historyLog = JSON.parse(history);
          renderHistory();
        }
      }

      function saveHistory() {
        localStorage.setItem('historyLog', JSON.stringify(historyLog));
      }

      function initialize() {
        loadSettings();
        loadStatus();
        loadHistory();
        initializeSettingsModal();
        updateModeButtons();
        updateSessionIndicator();
        updateTimerDisplay();
        applyTranslations();
        if (isRunning) {
          startTimer(true);
        }
        // Event listeners
        elements.startPauseButton.addEventListener('click', onStartPause);
        elements.skipButton.addEventListener('click', skipTimer);
        elements.pomodoroButton.addEventListener('click', () => switchMode('pomodoro'));
        elements.shortBreakButton.addEventListener('click', () => switchMode('shortBreak'));
        elements.longBreakButton.addEventListener('click', () => switchMode('longBreak'));
        elements.settingsButton.addEventListener('click', openSettingsModal);
        elements.closeSettingsButton.addEventListener('click', closeSettingsModal);
        elements.saveSettingsButton.addEventListener('click', saveSettingsModal);
        elements.darkModeToggle.addEventListener('click', toggleDarkMode);
        elements.clearHistoryButton.addEventListener('click', clearHistory);
        elements.resetAppButton.addEventListener('click', resetApp);
        elements.taskInput.addEventListener('input', saveStatus);
        elements.languageSelector.addEventListener('change', changeLanguage);
      }

      function applyTranslations() {
        const t = translations[currentLanguage];

        // Update the language attribute
        document.documentElement.lang = currentLanguage;

        // Update aria-labels
        elements.settingsButton.setAttribute('aria-label', t.settings);
        elements.darkModeToggle.setAttribute('aria-label', t.toggleDarkMode);
        elements.startPauseButton.setAttribute('aria-label', isRunning ? t.pause : t.start);
        elements.skipButton.setAttribute('aria-label', t.skip);
        elements.taskInput.setAttribute('aria-label', t.taskInputLabel);
        elements.languageSelector.setAttribute('aria-label', t.languageSelector || 'Language Selector');

        // Update buttons
        elements.pomodoroButton.innerHTML = `<i class="fas fa-clock mr-1"></i> ${t.pomodoro}`;
        elements.shortBreakButton.innerHTML = `<i class="fas fa-coffee mr-1"></i> ${t.shortBreak}`;
        elements.longBreakButton.innerHTML = `<i class="fas fa-umbrella-beach mr-1"></i> ${t.longBreak}`;
        elements.startPauseButton.innerHTML = `<i class="fas fa-${isRunning ? 'pause' : 'play'} mr-1"></i> ${isRunning ? t.pause : t.start}`;
        elements.skipButton.innerHTML = `<i class="fas fa-forward"></i> ${t.skip}`;

        // Update placeholders
        elements.taskInput.setAttribute('placeholder', t.whatAreYouWorkingOn);

        // Update labels
        const taskInputLabel = document.querySelector('label[for="task-input"]');
        if (taskInputLabel) {
          taskInputLabel.textContent = t.taskInputLabel;
        }

        // Update table headers
        const tableHeaders = elements.historyList.querySelectorAll('th');
        tableHeaders[0].textContent = t.type;
        tableHeaders[1].textContent = t.task;
        tableHeaders[2].textContent = t.startTime;
        tableHeaders[3].textContent = t.endTime;
        tableHeaders[4].textContent = t.duration;

        // Update settings modal
        document.getElementById('settings-modal-title').textContent = t.settingsModalTitle;
        document.querySelector('label[for="pomodoro-time-input"]').textContent = t.pomodoroTime;
        document.querySelector('label[for="short-break-time-input"]').textContent = t.shortBreakTime;
        document.querySelector('label[for="long-break-time-input"]').textContent = t.longBreakTime;
        document.querySelector('label[for="continuous-mode-checkbox"]').textContent = t.enableContinuousMode;
        document.querySelector('label[for="break-multiplier-input"]').textContent = t.shortBreakMultiplier;
        document.querySelector('label[for="long-break-multiplier-input"]').textContent = t.longBreakMultiplier;
        document.querySelector('label[for="sessions-before-long-break-input"]').textContent = t.sessionsBeforeLongBreak;
        document.querySelector('label[for="enable-webhook-checkbox"]').textContent = t.enableWebhooks;
        document.querySelector('label[for="webhook-url-input"]').textContent = t.webhookURL;
        elements.clearHistoryButton.textContent = t.clearHistory;
        elements.resetAppButton.textContent = t.resetApp;
        elements.closeSettingsButton.textContent = t.close;
        elements.saveSettingsButton.textContent = t.save;

        // Re-render history log with updated translations
        renderHistory();
      }

      function changeLanguage() {
        currentLanguage = elements.languageSelector.value;
        applyTranslations();
        saveSettings();
      }

      function initializeSettingsModal() {
        elements.pomodoroTimeInput.value = defaultTimes.pomodoro / 60;
        elements.shortBreakTimeInput.value = defaultTimes.shortBreak / 60;
        elements.longBreakTimeInput.value = defaultTimes.longBreak / 60;
        elements.continuousModeCheckbox.checked = continuousMode;
        elements.breakMultiplierInput.value = breakMultiplier;
        elements.longBreakMultiplierInput.value = longBreakMultiplier;
        elements.sessionsBeforeLongBreakInput.value = sessionsBeforeLongBreak;
        elements.enableWebhookCheckbox.checked = enableWebhook;
        elements.webhookURLInput.value = webhookURL;
      }

      function updateTimerDisplay() {
        const minutes = String(Math.floor(timeRemaining / 60)).padStart(2, '0');
        const seconds = String(timeRemaining % 60).padStart(2, '0');
        elements.timerDisplay.textContent = `${minutes}:${seconds}`;
        updateProgressRing();
      }

      function updateProgressRing() {
        const radius = elements.progressRingCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        elements.progressRingCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        let percent = timeRemaining / defaultTimes[currentMode];
        if (percent < 0) percent = 0;
        const offset = circumference - percent * circumference;
        elements.progressRingCircle.style.strokeDashoffset = offset;
      }

      function updateModeButtons() {
        elements.pomodoroButton.classList.remove('active');
        elements.shortBreakButton.classList.remove('active');
        elements.longBreakButton.classList.remove('active');

        if (currentMode === 'pomodoro') {
          elements.pomodoroButton.classList.add('active');
        } else if (currentMode === 'shortBreak') {
          elements.shortBreakButton.classList.add('active');
        } else if (currentMode === 'longBreak') {
          elements.longBreakButton.classList.add('active');
        }
      }

      function updateSessionIndicator() {
        elements.sessionIndicator.innerHTML = '';
        for (let i = 0; i < sessionsBeforeLongBreak; i++) {
          const icon = document.createElement('i');
          icon.classList.add('fas', 'fa-apple-alt', 'pomo-icon');
          if (i < completedSessions % sessionsBeforeLongBreak) {
            icon.classList.add('completed');
          }
          elements.sessionIndicator.appendChild(icon);
        }
      }

      function renderHistory() {
        const tbody = elements.historyList.querySelector('tbody');
        tbody.innerHTML = '';
        const t = translations[currentLanguage];
        historyLog.forEach(session => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-2 py-1 border-b">${t[session.type] || session.type}</td>
            <td class="px-2 py-1 border-b">${session.task || t.noTask}</td>
            <td class="px-2 py-1 border-b">${session.startTime}</td>
            <td class="px-2 py-1 border-b">${session.endTime}</td>
            <td class="px-2 py-1 border-b">${session.duration} min</td>
          `;
          tbody.appendChild(row);
        });
      }

      function onStartPause() {
        if (!isRunning) {
          startTimer();
        } else {
          if (continuousMode && currentMode === 'pomodoro') {
            pauseContinuousMode();
          } else {
            pauseTimer();
          }
        }
      }

      function startTimer(resuming = false) {
        isRunning = true;
        elements.startPauseButton.innerHTML = `<i class="fas fa-pause mr-1"></i> ${translations[currentLanguage].pause}`;
        let status;
        if (currentMode === 'pomodoro') {
          status = 'focusing';
        } else if (currentMode === 'shortBreak') {
          status = 'short_break';
        } else if (currentMode === 'longBreak') {
          status = 'long_break';
        }
        if (!resuming) {
          sendWebhook(status);
        }
        if (!expectedEndTime || !resuming) {
          expectedEndTime = Date.now() + timeRemaining * 1000;
        }
        timer = setInterval(timerTick, 1000);
        saveStatus();
      }

      function timerTick() {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
          clearInterval(timer);
          handleTimerCompletion();
        }
      }

      function handleTimerCompletion() {
        const t = translations[currentLanguage];
        alarmSound.play();
        isRunning = false;
        elements.startPauseButton.innerHTML = `<i class="fas fa-play mr-1"></i> ${t.start}`;
        sendWebhook('stopped');
        showBrowserNotification(`${t[currentMode]} ${t.pomodoroCompleted}`);
        const endTime = new Date();
        const duration = Math.round(defaultTimes[currentMode] / 60);
        addToHistoryLog({
          type: currentMode,
          task: elements.taskInput.value,
          startTime: endTime.toLocaleTimeString(),
          endTime: endTime.toLocaleTimeString(),
          duration: duration
        });
        if (currentMode === 'pomodoro') {
          completedSessions++;
          updateSessionIndicator();
          if (completedSessions % sessionsBeforeLongBreak === 0) {
            currentMode = 'longBreak';
            timeRemaining = defaultTimes.longBreak;
            showNotification(t.timeForLongBreak);
            showBrowserNotification(t.timeForLongBreak);
          } else {
            currentMode = 'shortBreak';
            timeRemaining = defaultTimes.shortBreak;
            showNotification(t.timeForShortBreak);
            showBrowserNotification(t.timeForShortBreak);
          }
        } else {
          currentMode = 'pomodoro';
          timeRemaining = defaultTimes.pomodoro;
          showNotification(t.backToWork);
          showBrowserNotification(t.backToWork);
        }
        expectedEndTime = null;
        updateModeButtons();
        updateTimerDisplay();
        saveStatus();
      }

      function pauseTimer() {
        const t = translations[currentLanguage];
        isRunning = false;
        elements.startPauseButton.innerHTML = `<i class="fas fa-play mr-1"></i> ${t.start}`;
        clearInterval(timer);
        expectedEndTime = null;
        sendWebhook('paused');
        saveStatus();
      }

      function pauseContinuousMode() {
        const t = translations[currentLanguage];
        pauseTimer();
        defaultTimes.shortBreak = Math.round(focusTime * breakMultiplier);
        defaultTimes.longBreak = Math.round(focusTime * longBreakMultiplier);
        currentMode = 'shortBreak';
        timeRemaining = defaultTimes.shortBreak;
        updateModeButtons();
        updateTimerDisplay();
        showNotification(t.shortBreakForMinutes.replace('{minutes}', Math.floor(defaultTimes.shortBreak / 60)));
        showBrowserNotification(t.shortBreakForMinutes.replace('{minutes}', Math.floor(defaultTimes.shortBreak / 60)));
        addToHistoryLog({
          type: 'pomodoro',
          task: elements.taskInput.value,
          startTime: new Date(new Date() - focusTime * 1000).toLocaleTimeString(),
          endTime: new Date().toLocaleTimeString(),
          duration: Math.round(focusTime / 60)
        });
        completedSessions++;
        updateSessionIndicator();
      }

      function resetTimer() {
        const t = translations[currentLanguage];
        pauseTimer();
        if (continuousMode && currentMode === 'pomodoro') {
          timeRemaining = 0;
        } else {
          timeRemaining = defaultTimes[currentMode];
        }
        elements.startPauseButton.innerHTML = `<i class="fas fa-play mr-1"></i> ${t.start}`;
        updateTimerDisplay();
        saveStatus();
      }

      function skipTimer() {
        const t = translations[currentLanguage];
        clearInterval(timer);
        isRunning = false;
        elements.startPauseButton.innerHTML = `<i class="fas fa-play mr-1"></i> ${t.start}`;
        expectedEndTime = null;
        sendWebhook('stopped');
        showBrowserNotification(t.timerSkipped);
        if (currentMode === 'pomodoro') {
          const endTime = new Date();
          const duration = Math.round((defaultTimes.pomodoro - timeRemaining) / 60);
          addToHistoryLog({
            type: 'pomodoroSkipped',
            task: elements.taskInput.value,
            startTime: endTime.toLocaleTimeString(),
            endTime: endTime.toLocaleTimeString(),
            duration: duration
          });
          completedSessions++;
          updateSessionIndicator();
          if (completedSessions % sessionsBeforeLongBreak === 0) {
            currentMode = 'longBreak';
            timeRemaining = defaultTimes.longBreak;
            showNotification(t.timeForLongBreak);
            showBrowserNotification(t.timeForLongBreak);
          } else {
            currentMode = 'shortBreak';
            timeRemaining = defaultTimes.shortBreak;
            showNotification(t.timeForShortBreak);
            showBrowserNotification(t.timeForShortBreak);
          }
        } else {
          currentMode = 'pomodoro';
          timeRemaining = defaultTimes.pomodoro;
          showNotification(t.backToWork);
          showBrowserNotification(t.backToWork);
        }
        updateModeButtons();
        updateTimerDisplay();
        saveStatus();
      }

      function switchMode(mode) {
        currentMode = mode;
        resetTimer();
        updateModeButtons();
      }

      function openSettingsModal() {
        elements.settingsModal.classList.remove('hidden');
        initializeSettingsModal();
        elements.settingsModal.querySelector('input, button, select, textarea').focus();
      }

      function closeSettingsModal() {
        elements.settingsModal.classList.add('hidden');
        elements.settingsButton.focus();
      }

      function saveSettingsModal() {
        defaultTimes.pomodoro = parseInt(elements.pomodoroTimeInput.value) * 60;
        defaultTimes.shortBreak = parseInt(elements.shortBreakTimeInput.value) * 60;
        defaultTimes.longBreak = parseInt(elements.longBreakTimeInput.value) * 60;
        continuousMode = elements.continuousModeCheckbox.checked;
        breakMultiplier = parseFloat(elements.breakMultiplierInput.value);
        longBreakMultiplier = parseFloat(elements.longBreakMultiplierInput.value);
        sessionsBeforeLongBreak = parseInt(elements.sessionsBeforeLongBreakInput.value);
        enableWebhook = elements.enableWebhookCheckbox.checked;
        webhookURL = elements.webhookURLInput.value.trim();
        saveSettings();
        resetTimer();
        updateModeButtons();
        closeSettingsModal();
      }

      function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        saveSettings();
      }

      function showNotification(message) {
        elements.notification.textContent = message;
        elements.notification.style.display = 'block';
        setTimeout(() => {
          elements.notification.style.display = 'none';
        }, 3000);
      }

      function showBrowserNotification(message) {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(message);
        }
      }

      function sendWebhook(status) {
        if (enableWebhook && webhookURL) {
          const payload = {
            status: status,
            taskName: elements.taskInput.value,
            time: new Date().toISOString()
          };
          fetch(webhookURL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          })
            .then(response => {
              if (!response.ok) {
                throw new Error('Webhook request failed with status ' + response.status);
              }
              return response.json();
            })
            .catch(error => {
              console.error('Webhook error:', error);
              const t = translations[currentLanguage];
              showNotification(`${t.webhookError} ${error.message}`);
            });
        }
      }

      function addToHistoryLog(session) {
        historyLog.push(session);
        saveHistory();
        renderHistory();
      }

      function clearHistory() {
        const t = translations[currentLanguage];
        if (confirm(t.confirmClearHistory)) {
          historyLog = [];
          saveHistory();
          renderHistory();
        }
      }

      function resetApp() {
        const t = translations[currentLanguage];
        if (confirm(t.confirmResetApp)) {
          localStorage.clear();
          location.reload();
        }
      }

      initialize();
    })();
  </script>
</body>

</html>